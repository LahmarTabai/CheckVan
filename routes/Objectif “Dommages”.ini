Objectif â€œDommagesâ€

Tracer prÃ©cisÃ©ment tout dommage constatÃ© sur un vÃ©hicule, au moment de la prise en charge (check-in) et Ã  la restitution (check-out), avec une localisation visuelle (coord_x, coord_y, coord_z), des preuves photo, un niveau de sÃ©vÃ©ritÃ©, et un cycle de vie (constatÃ© â†’ validÃ© â†’ rÃ©parÃ©).

ğŸ—ƒï¸ Rappel du modÃ¨le (table dommages)

Champs actuels :

id

affectation_id (rÃ©fÃ©rence Ã  lâ€™affectation en cours, câ€™est parfait)

chauffeur_id (qui a dÃ©clarÃ©/constatÃ© le dommage)

coord_x, coord_y, coord_z

type (ex. rayure, bosse, fissure, Ã©clat pare-briseâ€¦)

description

severite (ex. mineur, modÃ©rÃ©, majeur, critique)

photo_path (chemin vers la photo)

reparÃ© (boolÃ©en)

created_at, updated_at

ğŸ”— ClÃ©s Ã©trangÃ¨res Ã  prÃ©voir (si pas dÃ©jÃ  posÃ©es) :
affectation_id â†’ affectations.id (ON DELETE CASCADE)
chauffeur_id â†’ users.id (ON DELETE SET NULL / CASCADE selon ta politique)

ğŸ§­ InterprÃ©tation des coordonnÃ©es (coord_x, coord_y, coord_z)

Pour permettre lâ€™annotation 2D/3D :

coord_x, coord_y : coordonnÃ©es normalisÃ©es entre 0.0 et 1.0 sur lâ€™image/modÃ¨le sÃ©lectionnÃ©.

0,0 = coin haut-gauche ; 1,1 = coin bas-droit.

coord_z : index de la â€œfaceâ€ ou profondeur. Propos cohÃ©rent :

0 = Avant, 1 = ArriÃ¨re, 2 = Gauche, 3 = Droite, 4 = Haut, 5 = Bas (optionnel)

Si tu passes plus tard en modÃ¨le 3D, coord_z peut devenir la profondeur (0..1) et on ajoutera un champ face (enum).

Pour lâ€™instant, utilisons coord_z comme â€œface_idâ€ (entier 0..4).

âœ… Avantage : tu peux afficher un van 2D par face (images SVG/Canvas) ou basculer plus tard vers un viewer 3D, sans casser les donnÃ©es.

ğŸ‘¨â€ğŸ’¼ RÃ´le de lâ€™Admin dans les Dommages
1) Superviser & Valider

Voit tous les dommages enregistrÃ©s par ses chauffeurs (filtre par : vÃ©hicule, chauffeur, date, sÃ©vÃ©ritÃ©, face, statut â€œrÃ©parÃ© ou nonâ€).

Ouvre la fiche dommage : photo, point cliquÃ© sur la face du van, type, sÃ©vÃ©ritÃ©, description.

Valide le dommage (confirmÃ© ou Ã  rejeter si mauvais signalement).

(Avec le schÃ©ma actuel, la validation peut se modÃ©liser en ajoutant un champ virtuel cÃ´tÃ© UI ou un futur champ statut_validation. En attendant, on considÃ¨re â€œvalidÃ©â€ = acceptÃ© tacitement par lâ€™admin lors du traitement.)

2) DÃ©cider de lâ€™action

Planifier une rÃ©paration (crÃ©er une demande au garage, marquer â€œrÃ©parÃ©â€ quand câ€™est fait).

Ã‰valuer la responsabilitÃ© (chauffeur actuel, prÃ©cÃ©dent, indÃ©terminÃ©e).

(Option dâ€™Ã©volution : ajouter responsabilite et cout_estime/cout_reel. Pas obligatoire maintenant.)

3) ClÃ´turer / Mettre Ã  jour

Lorsque la rÃ©paration est effectuÃ©e, coche reparÃ© = true et, si tu veux, enregistre une photo aprÃ¨s rÃ©paration (tu peux rÃ©utiliser photo_path en le remplaÃ§ant, ou prÃ©voir plus tard une table dommages_photos si tu veux lâ€™historique complet).

4) Audit & Litiges

Historique par vÃ©hicule et par chauffeur (combien de dommages, quand, oÃ¹ sur le van).

Comparatifs : dommages â€œavant missionâ€ vs â€œaprÃ¨s missionâ€ (selon lâ€™affectation et les tÃ¢ches).

En cas de litige, lâ€™admin retrouve lâ€™image, lâ€™annotation (coordonnÃ©es/face) et la date.

ğŸšš RÃ´le du Chauffeur dans les Dommages
Lors de la prise en charge (check-in)

Le chauffeur inspecte le van par faces.

Il touche/click la zone abÃ®mÃ©e sur lâ€™image/3D â†’ on enregistre coord_x/y/z.

Il choisit un type (rayure, bosse, fissure, Ã©clatâ€¦), une sÃ©vÃ©ritÃ© (mineur/modÃ©rÃ©/majeur/critique).

Il ajoute une photo (obligatoire).

Valide lâ€™envoi â†’ le dommage est sauvegardÃ© avec affectation_id courant et reparÃ© = false.

ğŸ”’ RÃ¨gle mÃ©tier : pour finaliser la prise en charge, le chauffeur doit confirmer :

â€œAucun dommageâ€ ou â€œJâ€™ai listÃ© tous les dommagesâ€.

Pendant / Fin de mission (check-out)

Ã€ la restitution, il rÃ©pÃ¨te lâ€™inspection.

Si nouveau dommage, il enregistre un nouvel item (mÃªme process), rattachÃ© Ã  la mÃªme affectation_id.

Lâ€™app peut forcer la capture photo sâ€™il coche â€œdommage prÃ©sentâ€.

ğŸ§© FonctionnalitÃ©s cÃ´tÃ© Admin (UI)

Liste & filtres : vÃ©hicule (immatriculation), chauffeur, pÃ©riode, sÃ©vÃ©ritÃ©, face, â€œnon rÃ©parÃ©sâ€ dâ€™abord.

Carte/Tabs par vÃ©hicule :

â€œDommages actifsâ€ (reparÃ©=false)

â€œHistoriqueâ€

DÃ©tail dommage : photo zoomable, face du van avec le point (coord_x/y/z), mÃ©ta (type, sÃ©vÃ©ritÃ©, description).

Actions : â€œMarquer comme rÃ©parÃ©â€, â€œRejeterâ€ (si faux signalement), â€œPlanifier rÃ©parationâ€ (option).

Notifications : reÃ§oit une notif quand un nouveau dommage est signalÃ©.

ğŸ§© FonctionnalitÃ©s cÃ´tÃ© Chauffeur (UI)

Ã‰cran â€œPrise en chargeâ€ : galerie/3D des faces + â€œAjouter un dommageâ€.

Annoter : tap long, on plante un marqueur â†’ formulaire (type, sÃ©vÃ©ritÃ©, description, photo).

Liste des dommages de lâ€™affectation : voir ce quâ€™il a dÃ©jÃ  dÃ©clarÃ© + ce qui a Ã©tÃ© validÃ©/rÃ©parÃ© par lâ€™admin.

Fin de mission : procÃ©dure identique â†’ nouveaux dommages Ã©ventuels.

ğŸ“œ Logique MÃ©tier (rÃ¨gles clÃ©s)

IntÃ©gritÃ© dâ€™affectation

On nâ€™enregistre un dommage que sâ€™il existe une affectation en_cours pour ce chauffeur.

dommages.chauffeur_id doit == chauffeur connectÃ©, et affectation_id == affectation active de ce chauffeur.

UnicitÃ© â€œvisuelleâ€ facultative

(Option) EmpÃªcher la duplication sur la mÃªme face avec des coords trÃ¨s proches dans la mÃªme affectation (tolÃ©rance, ex. rayon 2â€“3%).

Sinon, on laisse lâ€™admin fusionner/fermer.

Photo obligatoire

Un dommage sans photo est refusÃ© (admin peut rejeter, la vue chauffeur doit bloquer lâ€™envoi sans photo).

SÃ©vÃ©ritÃ©

GuidÃ©e au chauffeur (ex. mineur = griffure fine ; majeur = enfoncement + peinture).

Sert Ã  prioriser cÃ´tÃ© admin (tri par sÃ©vÃ©ritÃ© dÃ©croissante).

RÃ©parÃ© = action admin

Seul lâ€™admin coche reparÃ© = true.

(Option) Tu peux exiger une photo aprÃ¨s rÃ©paration.

Cycle vie dommage vs mission

Tous les dommages dÃ©clarÃ©s pendant une affectation restent liÃ©s Ã  cette affectation.

Ã€ la fin, lâ€™admin voit la diffÃ©rence entre â€œÃ  lâ€™entrÃ©eâ€ et â€œÃ  la sortieâ€.

Notifications

Ã€ chaque nouveau dommage, envoie notif admin (FCM/email selon ton choix).

(Option) notif chauffeur si statut de rÃ©paration changÃ©.

ğŸ§± Performances & Index

Index conseillÃ©s :

dommages (affectation_id)

dommages (chauffeur_id)

(facultatif) dommages (reparÃ©, severite)

Si tu dois faire des heatmaps ou stats par face, prÃ©voir un index (affectation_id, coord_z).

ğŸš€ Ã‰volutions possibles (sans casser lâ€™existant)

Multi-photos par dommage â†’ table dommages_photos (dommage_id, path).

Validation explicite â†’ champ statut_validation enum('a_verifier','valide','rejete').

Attribution responsabilitÃ© â†’ champ responsabilite enum('chauffeur_actuel','precedent','indetermine').

CoÃ»ts & atelier â†’ cout_estime, cout_reel, prestataire, date_reparation.

Lien tÃ¢che â†’ si tu veux rattacher le dommage Ã  une tÃ¢che prÃ©cise, ajoute tache_id (nullable), mÃªme si affectation_id reste la clÃ© principale.

âœ… RÃ©sumÃ© opÃ©rationnel

Au check-in (prise en charge) : le chauffeur annote + photo â†’ dommages enregistrÃ©s (affectation en cours).

Pendant / au check-out : idem, pour nouveaux dommages.

Admin : valide, priorise, planifie, marque rÃ©parÃ©, suit lâ€™historique par vÃ©hicule et par chauffeur.

DonnÃ©es : coordonnÃ©es normalisÃ©es, face (via coord_z), photo obligatoire, sÃ©vÃ©ritÃ©/type standardisÃ©s.